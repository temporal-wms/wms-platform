{{- if .Values.gateway.enabled }}
{{- $gatewayNamespace := .Values.gateway.namespace | default "kong" }}
{{- $wmsNamespace := .Values.global.namespace }}
{{- range $serviceName, $serviceConfig := .Values.services }}
{{- if $serviceConfig.enabled }}
{{- /* Skip worker services - they don't have HTTP endpoints to expose */ -}}
{{- if ne $serviceConfig.type "worker" }}
{{- /* Check if service should be exposed via gateway (default: true for non-workers) */ -}}
{{- $exposeViaGateway := true }}
{{- if hasKey $serviceConfig "gateway" }}
{{- if hasKey $serviceConfig.gateway "enabled" }}
{{- $exposeViaGateway = $serviceConfig.gateway.enabled }}
{{- end }}
{{- end }}
{{- if $exposeViaGateway }}
---
# HTTPRoute for {{ $serviceName }}
# Routes: /{{ $serviceName }}/* -> {{ $serviceName }}:{{ $serviceConfig.ports.http }}/*
# Using Kong's strip-path to remove /{{ $serviceName }} prefix
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $serviceName }}-route
  namespace: {{ $wmsNamespace }}
  labels:
    app: {{ $serviceName }}
    app.kubernetes.io/name: {{ $serviceName }}
    app.kubernetes.io/component: httproute
  annotations:
    konghq.com/strip-path: "true"
spec:
  parentRefs:
    - name: wms-gateway
      namespace: {{ $gatewayNamespace }}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /{{ $serviceName }}
      backendRefs:
        - name: {{ $serviceName }}
          port: {{ $serviceConfig.ports.http }}
          kind: Service
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
