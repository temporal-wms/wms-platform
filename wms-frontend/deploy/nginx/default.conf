server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ============================================
    # API Proxy to backend services
    # ============================================

    location /api/orders/ {
        proxy_pass http://order-service.wms-platform-dev.svc.cluster.local:8001/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location /api/waves/ {
        proxy_pass http://waving-service.wms-platform-dev.svc.cluster.local:8002/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location /api/routing/ {
        proxy_pass http://routing-service.wms-platform-dev.svc.cluster.local:8003/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location /api/picking/ {
        proxy_pass http://picking-service.wms-platform-dev.svc.cluster.local:8004/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location /api/consolidation/ {
        proxy_pass http://consolidation-service.wms-platform-dev.svc.cluster.local:8005/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location /api/packing/ {
        proxy_pass http://packing-service.wms-platform-dev.svc.cluster.local:8006/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location /api/shipping/ {
        proxy_pass http://shipping-service.wms-platform-dev.svc.cluster.local:8007/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location /api/inventory/ {
        proxy_pass http://inventory-service.wms-platform-dev.svc.cluster.local:8008/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location /api/labor/ {
        proxy_pass http://labor-service.wms-platform-dev.svc.cluster.local:8009/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    # Proxy to microfrontend remotes (for Module Federation)
    # Use ^~ to prevent regex locations from taking precedence
    location ^~ /remotes/orders/ {
        proxy_pass http://wms-orders-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/waves/ {
        proxy_pass http://wms-waves-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/inventory/ {
        proxy_pass http://wms-inventory-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/picking/ {
        proxy_pass http://wms-picking-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/packing/ {
        proxy_pass http://wms-packing-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/shipping/ {
        proxy_pass http://wms-shipping-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/labor/ {
        proxy_pass http://wms-labor-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/dashboard/ {
        proxy_pass http://wms-dashboard-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/receiving/ {
        proxy_pass http://wms-receiving-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/stow/ {
        proxy_pass http://wms-stow-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/routing/ {
        proxy_pass http://wms-routing-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/walling/ {
        proxy_pass http://wms-walling-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/consolidation/ {
        proxy_pass http://wms-consolidation-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/sortation/ {
        proxy_pass http://wms-sortation-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    location ^~ /remotes/facility/ {
        proxy_pass http://wms-facility-mf.wms-frontend.svc.cluster.local/;
        proxy_http_version 1.1;
        add_header Access-Control-Allow-Origin *;
    }

    # Static assets with caching
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Remote entry files - no caching (for Module Federation)
    location ~ remoteEntry\.js$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;

        # Don't cache HTML
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }
    }

    # Error pages
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
