openapi: 3.0.3
info:
  title: Order Service API
  description: |
    Comprehensive REST API for order management operations in the WMS platform.

    This service handles:
    - Order creation and validation
    - Order lifecycle management
    - Order-wave assignment tracking
    - Order status updates and queries
  version: 1.0.0
  contact:
    name: WMS Platform Team
    email: wms@example.com

servers:
  - url: http://localhost:8001/api/v1
    description: Development server
  - url: https://api.wms.example.com/api/v1
    description: Production server

tags:
  - name: Orders
    description: Order management operations
  - name: Reprocessing
    description: Order reprocessing and retry operations
  - name: Dead Letter Queue
    description: Dead letter queue management for failed orders
  - name: Health
    description: Service health and readiness

paths:
  /orders:
    post:
      summary: Create a new order
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/FacilityIdHeader'
        - $ref: '#/components/parameters/WarehouseIdHeader'
        - $ref: '#/components/parameters/SellerIdHeader'
        - $ref: '#/components/parameters/ChannelIdHeader'
        - $ref: '#/components/parameters/TraceParent'
        - $ref: '#/components/parameters/TraceState'
        - $ref: '#/components/parameters/WMSCorrelationID'
        - $ref: '#/components/parameters/WMSWaveNumber'
        - $ref: '#/components/parameters/WMSWorkflowID'
      description: Creates a new order in the system and triggers the order fulfillment workflow
      tags:
        - Orders
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
            examples:
              sameDayOrder:
                summary: Same-day priority order
                value:
                  customerId: "CUST-12345"
                  priority: "same_day"
                  promisedDeliveryAt: "2024-12-24T20:00:00Z"
                  shippingAddress:
                    street: "123 Main St"
                    city: "San Francisco"
                    state: "CA"
                    zipCode: "94105"
                    country: "US"
                  items:
                    - sku: "WIDGET-001"
                      quantity: 2
                      unitPrice: 19.99
                    - sku: "GADGET-002"
                      quantity: 1
                      unitPrice: 49.99
              standardOrder:
                summary: Standard priority order
                value:
                  customerId: "CUST-67890"
                  priority: "standard"
                  promisedDeliveryAt: "2024-12-27T17:00:00Z"
                  shippingAddress:
                    street: "456 Oak Ave"
                    street2: "Suite 200"
                    city: "Los Angeles"
                    state: "CA"
                    zipCode: "90001"
                    country: "US"
                  items:
                    - sku: "WIDGET-003"
                      quantity: 5
                      unitPrice: 9.99
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                createdOrder:
                  value:
                    orderId: "ORD-A1B2C3D4"
                    customerId: "CUST-12345"
                    status: "received"
                    priority: "same_day"
                    promisedDeliveryAt: "2024-12-24T20:00:00Z"
                    shippingAddress:
                      street: "123 Main St"
                      city: "San Francisco"
                      state: "CA"
                      zipCode: "94105"
                      country: "US"
                    items:
                      - sku: "WIDGET-001"
                        productName: "Premium Widget"
                        quantity: 2
                        unitPrice: 19.99
                        weight: 0.5
                      - sku: "GADGET-002"
                        productName: "Smart Gadget"
                        quantity: 1
                        unitPrice: 49.99
                        weight: 1.2
                    totalItems: 2
                    totalQuantity: 3
                    totalWeight: 2.2
                    totalValue: 89.97
                    createdAt: "2024-12-24T10:00:00Z"
                    updatedAt: "2024-12-24T10:00:00Z"
        '400':
          description: Invalid request
        '500':
          description: Internal server error

    get:
      summary: List orders
      description: Retrieve a paginated list of orders with optional filtering
      tags:
        - Orders
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/FacilityIdHeader'
        - $ref: '#/components/parameters/WarehouseIdHeader'
        - $ref: '#/components/parameters/SellerIdHeader'
        - $ref: '#/components/parameters/ChannelIdHeader'
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: pageSize
          in: query
          schema:
            type: integer
            default: 20
        - name: status
          in: query
          schema:
            type: string
            enum: [received, validated, assigned_to_wave, picking, packing, shipped, completed, cancelled]
        - name: priority
          in: query
          schema:
            type: string
            enum: [same_day, next_day, standard]
        - name: customerId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of orders retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderListItem'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      pageSize:
                        type: integer
                      total:
                        type: integer
                      hasMore:
                        type: boolean

  /orders/{orderId}:
    get:
      summary: Get order by ID
      tags:
        - Orders
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '404':
          description: Order not found

  /orders/{orderId}/validate:
    put:
      summary: Validate order
      tags:
        - Orders
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order validated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'

  /orders/{orderId}/cancel:
    put:
      summary: Cancel order
      tags:
        - Orders
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Order cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'

  /health:
    get:
      summary: Health check
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy

  # Reprocessing Endpoints
  /reprocessing/eligible:
    get:
      summary: Get orders eligible for retry
      description: Retrieve orders that are eligible for reprocessing based on retry count and status
      tags:
        - Reprocessing
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: maxRetries
          in: query
          schema:
            type: integer
            default: 5
        - name: status
          in: query
          schema:
            type: array
            items:
              type: string
      responses:
        '200':
          description: List of eligible orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/EligibleOrderItem'
                  total:
                    type: integer

  /reprocessing/orders/{orderId}/retry-count:
    get:
      summary: Get retry metadata for order
      tags:
        - Reprocessing
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Retry metadata retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetryMetadata'
        '404':
          description: Order not found
    post:
      summary: Increment retry count
      tags:
        - Reprocessing
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                failureReason:
                  type: string
                failedAt:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Retry count incremented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetryMetadata'

  /reprocessing/orders/{orderId}/reset:
    post:
      summary: Reset order for retry
      description: Reset order status to allow reprocessing from the beginning
      tags:
        - Reprocessing
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order reset successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '404':
          description: Order not found

  /reprocessing/orders/{orderId}/dlq:
    post:
      summary: Move order to dead letter queue
      description: Move a failed order to the dead letter queue after max retries exceeded
      tags:
        - Reprocessing
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - failureStatus
                - failureReason
              properties:
                failureStatus:
                  type: string
                failureReason:
                  type: string
      responses:
        '200':
          description: Order moved to DLQ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQEntry'

  # Dead Letter Queue Endpoints
  /dead-letter-queue:
    get:
      summary: List dead letter queue entries
      description: Retrieve failed orders from the dead letter queue with optional filtering
      tags:
        - Dead Letter Queue
      parameters:
        - name: resolved
          in: query
          schema:
            type: boolean
        - name: failureStatus
          in: query
          schema:
            type: string
        - name: customerId
          in: query
          schema:
            type: string
        - name: olderThanHours
          in: query
          schema:
            type: number
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: DLQ entries retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/DLQEntry'
                  total:
                    type: integer

  /dead-letter-queue/stats:
    get:
      summary: Get DLQ statistics
      description: Retrieve statistics about dead letter queue entries
      tags:
        - Dead Letter Queue
      responses:
        '200':
          description: DLQ stats retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQStats'

  /dead-letter-queue/{orderId}:
    get:
      summary: Get specific DLQ entry
      tags:
        - Dead Letter Queue
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: DLQ entry retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQEntry'
        '404':
          description: DLQ entry not found

  /dead-letter-queue/{orderId}/resolve:
    patch:
      summary: Resolve DLQ entry
      description: Mark a dead letter queue entry as resolved with resolution details
      tags:
        - Dead Letter Queue
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - resolution
              properties:
                resolution:
                  type: string
                  enum: [manual_retry, cancelled, escalated]
                notes:
                  type: string
                resolvedBy:
                  type: string
      responses:
        '200':
          description: DLQ entry resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQEntry'
        '404':
          description: DLQ entry not found

components:
  schemas:
    CreateOrderRequest:
      type: object
      required:
        - customerId
        - priority
        - shippingAddress
        - items
      properties:
        customerId:
          type: string
        priority:
          type: string
          enum: [same_day, next_day, standard]
        promisedDeliveryAt:
          type: string
          format: date-time
        shippingAddress:
          $ref: '#/components/schemas/Address'
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItemInput'

    OrderItemInput:
      type: object
      required:
        - sku
        - quantity
        - unitPrice
      properties:
        sku:
          type: string
        quantity:
          type: integer
        unitPrice:
          type: number

    OrderResponse:
      type: object
      properties:
        orderId:
          type: string
        customerId:
          type: string
        status:
          type: string
        priority:
          type: string
        promisedDeliveryAt:
          type: string
          format: date-time
        shippingAddress:
          $ref: '#/components/schemas/Address'
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        totalItems:
          type: integer
        totalQuantity:
          type: integer
        totalWeight:
          type: number
        totalValue:
          type: number
        waveId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OrderItem:
      type: object
      properties:
        sku:
          type: string
        productName:
          type: string
        quantity:
          type: integer
        unitPrice:
          type: number
        weight:
          type: number

    OrderListItem:
      type: object
      properties:
        orderId:
          type: string
        customerId:
          type: string
        status:
          type: string
        priority:
          type: string
        totalItems:
          type: integer
        totalQuantity:
          type: integer
        waveId:
          type: string
        createdAt:
          type: string
          format: date-time

    Address:
      type: object
      required:
        - street
        - city
        - state
        - zipCode
        - country
      properties:
        street:
          type: string
        street2:
          type: string
        city:
          type: string
        state:
          type: string
        zipCode:
          type: string
        country:
          type: string

    EligibleOrderItem:
      type: object
      properties:
        orderId:
          type: string
        customerId:
          type: string
        status:
          type: string
        retryCount:
          type: integer
        lastFailureReason:
          type: string
        lastFailedAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time

    RetryMetadata:
      type: object
      properties:
        orderId:
          type: string
        retryCount:
          type: integer
        maxRetries:
          type: integer
        lastFailureReason:
          type: string
        lastFailedAt:
          type: string
          format: date-time
        nextRetryAt:
          type: string
          format: date-time
        isEligibleForRetry:
          type: boolean

    DLQEntry:
      type: object
      properties:
        orderId:
          type: string
        customerId:
          type: string
        failureStatus:
          type: string
        failureReason:
          type: string
        retryCount:
          type: integer
        originalOrder:
          $ref: '#/components/schemas/OrderResponse'
        resolved:
          type: boolean
        resolution:
          type: string
          enum: [manual_retry, cancelled, escalated]
        resolvedBy:
          type: string
        resolvedAt:
          type: string
          format: date-time
        notes:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    DLQStats:
      type: object
      properties:
        totalEntries:
          type: integer
        unresolvedCount:
          type: integer
        resolvedCount:
          type: integer
        byFailureStatus:
          type: object
          additionalProperties:
            type: integer
        byResolution:
          type: object
          additionalProperties:
            type: integer
        oldestUnresolvedAt:
          type: string
          format: date-time

  parameters:
    # WMS Tenant Context Headers (Multi-Tenancy - REQUIRED)
    TenantIdHeader:
      name: X-WMS-Tenant-ID
      in: header
      required: true
      description: |
        Tenant identifier for multi-tenant isolation.
        Required for all API operations to ensure proper data segregation.
      schema:
        type: string
      example: "tenant-001"

    FacilityIdHeader:
      name: X-WMS-Facility-ID
      in: header
      required: true
      description: |
        Facility/distribution center identifier.
        Required for all API operations to route requests to the correct facility.
      schema:
        type: string
      example: "facility-east"

    WarehouseIdHeader:
      name: X-WMS-Warehouse-ID
      in: header
      required: true
      description: |
        Warehouse identifier within the facility.
        Required for all API operations for warehouse-specific processing.
      schema:
        type: string
      example: "warehouse-a"

    SellerIdHeader:
      name: X-WMS-Seller-ID
      in: header
      required: false
      description: |
        Seller identifier for marketplace operations.
        Optional - used for multi-seller scenarios.
      schema:
        type: string
      example: "seller-123"

    ChannelIdHeader:
      name: X-WMS-Channel-ID
      in: header
      required: false
      description: |
        Sales channel identifier (e.g., web, mobile, marketplace).
        Optional - used for channel-specific processing.
      schema:
        type: string
      example: "web"

    # W3C Trace Context Headers (Distributed Tracing)
    TraceParent:
      name: traceparent
      in: header
      description: |
        W3C Trace Context traceparent header for distributed tracing.
        Format: version-trace_id-span_id-trace_flags
        Enables end-to-end trace correlation across service boundaries.
      required: false
      schema:
        type: string
        pattern: "^[0-9a-f]{2}-[0-9a-f]{32}-[0-9a-f]{16}-[0-9a-f]{2}$"
      example: "00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01"

    TraceState:
      name: tracestate
      in: header
      description: |
        W3C Trace Context tracestate header for vendor-specific trace state.
        Format: vendor1=value1,vendor2=value2
      required: false
      schema:
        type: string
      example: "rojo=00f067aa0ba902b7,congo=t61rcWkgMzE"

    # WMS Custom Headers (Business Context)
    WMSCorrelationID:
      name: X-WMS-Correlation-ID
      in: header
      description: |
        CloudEvents extension for business correlation across WMS workflows.
        NOTE: For distributed tracing, use traceparent/tracestate headers.
      required: false
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

    WMSWaveNumber:
      name: X-WMS-Wave-Number
      in: header
      description: CloudEvents extension for wave-based processing correlation
      required: false
      schema:
        type: string
      example: "WAVE-2024-00123"

    WMSWorkflowID:
      name: X-WMS-Workflow-ID
      in: header
      description: CloudEvents extension for Temporal workflow correlation
      required: false
      schema:
        type: string
      example: "order-fulfillment-ORD-12345"
