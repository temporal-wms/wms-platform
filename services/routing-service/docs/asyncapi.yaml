asyncapi: 3.0.0
info:
  title: WMS Routing Service Events
  version: 1.0.0
  description: |
    AsyncAPI specification for Routing Service domain events.

    The Routing service publishes events to track route calculation, execution,
    and completion progress. Events follow the CloudEvents 1.0 specification.

    **Event Flow:**
    1. RouteCreated - When a new pick route is calculated
    2. RouteStarted - When a picker begins executing a route
    3. StopCompleted - When a stop on the route is completed
    4. StopSkipped - When a stop is skipped due to issues
    5. RoutePaused - When a route is paused
    6. RouteResumed - When a paused route is resumed
    7. RouteCompleted - When all stops are processed
    8. RouteCancelled - When a route is cancelled

    **Integration:**
    - WES listens for RouteCompleted to advance fulfillment stages
    - Labor Service listens for route events for productivity tracking
    - Inventory Service listens for StopSkipped for discrepancy handling
  contact:
    name: WMS Platform Team
    email: wms@example.com

servers:
  kafka:
    host: localhost:9092
    protocol: kafka
    description: Local Kafka broker

defaultContentType: application/json

channels:
  wms.routing.events:
    address: wms.routing.events
    description: Route lifecycle events topic (3 partitions, keyed by routeId)
    messages:
      routeCreated:
        $ref: '#/components/messages/RouteCreatedEvent'
      routeStarted:
        $ref: '#/components/messages/RouteStartedEvent'
      stopCompleted:
        $ref: '#/components/messages/StopCompletedEvent'
      stopSkipped:
        $ref: '#/components/messages/StopSkippedEvent'
      routePaused:
        $ref: '#/components/messages/RoutePausedEvent'
      routeResumed:
        $ref: '#/components/messages/RouteResumedEvent'
      routeCompleted:
        $ref: '#/components/messages/RouteCompletedEvent'
      routeCancelled:
        $ref: '#/components/messages/RouteCancelledEvent'

operations:
  publishRouteCreated:
    action: send
    channel:
      $ref: '#/channels/wms.routing.events'
    summary: Publish route created event
    description: Published when a new pick route is calculated and ready for execution
    messages:
      - $ref: '#/channels/wms.routing.events/messages/routeCreated'

  publishRouteStarted:
    action: send
    channel:
      $ref: '#/channels/wms.routing.events'
    summary: Publish route started event
    description: Published when a picker begins executing a route
    messages:
      - $ref: '#/channels/wms.routing.events/messages/routeStarted'

  publishStopCompleted:
    action: send
    channel:
      $ref: '#/channels/wms.routing.events'
    summary: Publish stop completed event
    description: Published when a picker completes a stop on the route
    messages:
      - $ref: '#/channels/wms.routing.events/messages/stopCompleted'

  publishStopSkipped:
    action: send
    channel:
      $ref: '#/channels/wms.routing.events'
    summary: Publish stop skipped event
    description: Published when a stop is skipped due to unavailability or issues
    messages:
      - $ref: '#/channels/wms.routing.events/messages/stopSkipped'

  publishRoutePaused:
    action: send
    channel:
      $ref: '#/channels/wms.routing.events'
    summary: Publish route paused event
    description: Published when a route is temporarily paused
    messages:
      - $ref: '#/channels/wms.routing.events/messages/routePaused'

  publishRouteResumed:
    action: send
    channel:
      $ref: '#/channels/wms.routing.events'
    summary: Publish route resumed event
    description: Published when a paused route is resumed
    messages:
      - $ref: '#/channels/wms.routing.events/messages/routeResumed'

  publishRouteCompleted:
    action: send
    channel:
      $ref: '#/channels/wms.routing.events'
    summary: Publish route completed event
    description: Published when all stops on a route are processed
    messages:
      - $ref: '#/channels/wms.routing.events/messages/routeCompleted'

  publishRouteCancelled:
    action: send
    channel:
      $ref: '#/channels/wms.routing.events'
    summary: Publish route cancelled event
    description: Published when a route is cancelled
    messages:
      - $ref: '#/channels/wms.routing.events/messages/routeCancelled'

components:
  messages:
    RouteCreatedEvent:
      name: RouteCreatedEvent
      title: Route Created
      summary: Published when a new pick route is calculated
      description: |
        Triggered when the routing service calculates a new optimized route.
        Contains route details including stops, strategy, and estimates.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RouteCreatedPayload'
      examples:
        - name: routeCreated
          summary: Route created with shortest path strategy
          payload:
            routeId: "RT-a1b2c3d4"
            waveId: "WAVE-2024-00123"
            orderId: "ORD-A1B2C3D4"
            pickerId: "PICKER-001"
            strategy: "shortest_path"
            stopsCount: 5
            estimatedDistance: 125.5
            estimatedTimeMinutes: 8
            createdAt: "2024-12-24T10:00:00Z"

    RouteStartedEvent:
      name: RouteStartedEvent
      title: Route Started
      summary: Published when a picker starts a route
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RouteStartedPayload'
      examples:
        - name: routeStarted
          summary: Picker started route
          payload:
            routeId: "RT-a1b2c3d4"
            pickerId: "PICKER-001"
            startedAt: "2024-12-24T10:02:00Z"

    StopCompletedEvent:
      name: StopCompletedEvent
      title: Stop Completed
      summary: Published when a picker completes a stop on the route
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/StopCompletedPayload'
      examples:
        - name: stopCompleted
          summary: Stop completed with full quantity
          payload:
            routeId: "RT-a1b2c3d4"
            stopNumber: 1
            locationId: "A-01-02-03"
            sku: "WIDGET-001"
            expectedQuantity: 2
            actualQuantity: 2
            completedAt: "2024-12-24T10:04:00Z"

    StopSkippedEvent:
      name: StopSkippedEvent
      title: Stop Skipped
      summary: Published when a stop is skipped due to unavailability
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/StopSkippedPayload'
      examples:
        - name: stopSkipped
          summary: Stop skipped - out of stock
          payload:
            routeId: "RT-a1b2c3d4"
            stopNumber: 3
            locationId: "B-02-01-04"
            sku: "GADGET-002"
            expectedQuantity: 1
            reason: "out_of_stock"
            notes: "Location empty, no inventory found"
            skippedAt: "2024-12-24T10:06:00Z"

    RoutePausedEvent:
      name: RoutePausedEvent
      title: Route Paused
      summary: Published when a route is temporarily paused
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RoutePausedPayload'
      examples:
        - name: routePaused
          summary: Route paused for break
          payload:
            routeId: "RT-a1b2c3d4"
            pickerId: "PICKER-001"
            reason: "Scheduled break"
            stopsCompleted: 3
            stopsRemaining: 2
            pausedAt: "2024-12-24T10:05:00Z"

    RouteResumedEvent:
      name: RouteResumedEvent
      title: Route Resumed
      summary: Published when a paused route is resumed
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RouteResumedPayload'
      examples:
        - name: routeResumed
          summary: Route resumed after break
          payload:
            routeId: "RT-a1b2c3d4"
            pickerId: "PICKER-001"
            pauseDuration: "PT15M"
            resumedAt: "2024-12-24T10:20:00Z"

    RouteCompletedEvent:
      name: RouteCompletedEvent
      title: Route Completed
      summary: Published when all stops on a route are processed
      description: |
        Triggered when a route is fully completed.
        WES workflow listens for this to advance to next stage.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RouteCompletedPayload'
      examples:
        - name: routeCompleted
          summary: Route completed successfully
          payload:
            routeId: "RT-a1b2c3d4"
            waveId: "WAVE-2024-00123"
            orderId: "ORD-A1B2C3D4"
            pickerId: "PICKER-001"
            stopsCompleted: 4
            stopsSkipped: 1
            totalQuantityPicked: 8
            estimatedTimeMinutes: 8
            actualTimeMinutes: 10
            efficiency: 85.5
            completedAt: "2024-12-24T10:10:00Z"

    RouteCancelledEvent:
      name: RouteCancelledEvent
      title: Route Cancelled
      summary: Published when a route is cancelled
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RouteCancelledPayload'
      examples:
        - name: routeCancelled
          summary: Route cancelled due to order cancellation
          payload:
            routeId: "RT-a1b2c3d4"
            orderId: "ORD-A1B2C3D4"
            reason: "Order cancelled by customer"
            stopsCompleted: 2
            stopsRemaining: 3
            cancelledAt: "2024-12-24T10:05:00Z"

  schemas:
    CloudEventHeaders:
      $ref: '../../../shared/docs/asyncapi-cloudevents-schema.yaml#/CloudEventHeaders'
    RouteCreatedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        waveId:
          type: string
          example: "WAVE-2024-00123"
        orderId:
          type: string
          example: "ORD-A1B2C3D4"
        pickerId:
          type: string
          example: "PICKER-001"
        strategy:
          type: string
          enum: [shortest_path, zone_based, priority_first, batch_pick]
        stopsCount:
          type: integer
          example: 5
        estimatedDistance:
          type: number
          example: 125.5
        estimatedTimeMinutes:
          type: integer
          example: 8
        createdAt:
          type: string
          format: date-time

    RouteStartedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        pickerId:
          type: string
          example: "PICKER-001"
        startedAt:
          type: string
          format: date-time

    StopCompletedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        stopNumber:
          type: integer
          example: 1
        locationId:
          type: string
          example: "A-01-02-03"
        sku:
          type: string
          example: "WIDGET-001"
        expectedQuantity:
          type: integer
          example: 2
        actualQuantity:
          type: integer
          example: 2
        completedAt:
          type: string
          format: date-time

    StopSkippedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        stopNumber:
          type: integer
          example: 3
        locationId:
          type: string
          example: "B-02-01-04"
        sku:
          type: string
          example: "GADGET-002"
        expectedQuantity:
          type: integer
          example: 1
        reason:
          type: string
          enum: [out_of_stock, location_blocked, item_damaged, other]
          example: "out_of_stock"
        notes:
          type: string
          example: "Location empty, no inventory found"
        skippedAt:
          type: string
          format: date-time

    RoutePausedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        pickerId:
          type: string
          example: "PICKER-001"
        reason:
          type: string
          example: "Scheduled break"
        stopsCompleted:
          type: integer
          example: 3
        stopsRemaining:
          type: integer
          example: 2
        pausedAt:
          type: string
          format: date-time

    RouteResumedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        pickerId:
          type: string
          example: "PICKER-001"
        pauseDuration:
          type: string
          description: ISO 8601 duration
          example: "PT15M"
        resumedAt:
          type: string
          format: date-time

    RouteCompletedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        waveId:
          type: string
          example: "WAVE-2024-00123"
        orderId:
          type: string
          example: "ORD-A1B2C3D4"
        pickerId:
          type: string
          example: "PICKER-001"
        stopsCompleted:
          type: integer
          example: 4
        stopsSkipped:
          type: integer
          example: 1
        totalQuantityPicked:
          type: integer
          example: 8
        estimatedTimeMinutes:
          type: integer
          example: 8
        actualTimeMinutes:
          type: integer
          example: 10
        efficiency:
          type: number
          description: Efficiency score 0-100
          example: 85.5
        completedAt:
          type: string
          format: date-time

    RouteCancelledPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-A1B2C3D4"
        reason:
          type: string
          example: "Order cancelled by customer"
        stopsCompleted:
          type: integer
          example: 2
        stopsRemaining:
          type: integer
          example: 3
        cancelledAt:
          type: string
          format: date-time
