openapi: 3.0.3
info:
  title: WMS Picking Service API
  description: |
    REST API for pick task management and execution in the WMS Platform.

    This service handles:
    - Pick task creation and lifecycle management
    - Picker assignment and workload distribution
    - Item picking confirmation and tracking
    - Exception handling for short picks and damaged items
    - Integration with WES for route-based picking

    **Pick Task Lifecycle:**
    1. Created - Task ready for assignment
    2. Assigned - Picker assigned to task
    3. In Progress - Picker actively picking items
    4. Completed - All items picked successfully
    5. Cancelled - Task cancelled (order cancelled, etc.)

    **Process Paths:**
    - `pick_pack`: Direct pick to pack station
    - `pick_wall_pack`: Pick to tote, sort at put-wall, then pack
    - `pick_consolidate_pack`: Pick to tote, consolidate multi-zone, then pack
  version: 1.0.0
  contact:
    name: WMS Platform Team
    email: wms@example.com

servers:
  - url: http://localhost:8004/api/v1
    description: Development server
  - url: https://api.wms.example.com/api/v1
    description: Production server

tags:
  - name: Tasks
    description: Pick task lifecycle management
  - name: Operations
    description: Picking operations and item confirmation
  - name: Exceptions
    description: Exception handling for pick issues
  - name: Queries
    description: Task queries and lookups
  - name: Health
    description: Service health and readiness

paths:
  /tasks:
    post:
      summary: Create pick task
      description: |
        Creates a new pick task for an order. The task contains items to be picked
        from specified warehouse locations.

        **Integration:**
        - Called by WES workflow during route execution
        - Publishes `PickTaskCreated` event on success
      tags: [Tasks]
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - $ref: '#/components/parameters/FacilityIdHeader'
        - $ref: '#/components/parameters/WarehouseIdHeader'
        - $ref: '#/components/parameters/SellerIdHeader'
        - $ref: '#/components/parameters/ChannelIdHeader'
        - $ref: '#/components/parameters/WMSCorrelationID'
        - $ref: '#/components/parameters/WMSWaveNumber'
        - $ref: '#/components/parameters/WMSWorkflowID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePickTaskRequest'
            examples:
              singleItem:
                summary: Single item pick task
                value:
                  orderId: "ORD-A1B2C3D4"
                  routeId: "RT-xyz123"
                  items:
                    - sku: "WIDGET-001"
                      quantity: 2
                      locationId: "A-1-2-3"
              multiItem:
                summary: Multi-item pick task
                value:
                  orderId: "ORD-E5F6G7H8"
                  routeId: "RT-abc456"
                  toteId: "TOTE-001"
                  items:
                    - sku: "WIDGET-001"
                      quantity: 3
                      locationId: "A-1-2-3"
                    - sku: "GADGET-002"
                      quantity: 1
                      locationId: "B-2-3-4"
                    - sku: "PART-003"
                      quantity: 5
                      locationId: "C-3-4-5"
      responses:
        '201':
          description: Pick task created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
              examples:
                created:
                  value:
                    taskId: "PT-a1b2c3d4"
                    orderId: "ORD-A1B2C3D4"
                    routeId: "RT-xyz123"
                    status: "pending"
                    items:
                      - sku: "WIDGET-001"
                        quantity: 2
                        locationId: "A-1-2-3"
                        picked: false
                        pickedQty: 0
                    totalItems: 1
                    totalQuantity: 2
                    createdAt: "2024-12-24T10:00:00Z"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Task already exists for order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      summary: List pick tasks
      description: Retrieve a paginated list of pick tasks with optional filtering
      tags: [Queries]
      parameters:
        - name: status
          in: query
          description: Filter by task status
          schema:
            type: string
            enum: [pending, assigned, in_progress, completed, cancelled]
        - name: pickerId
          in: query
          description: Filter by assigned picker
          schema:
            type: string
        - name: orderId
          in: query
          description: Filter by order ID
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of pick tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PickTaskResponse'
                  total:
                    type: integer
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /tasks/{taskId}:
    get:
      summary: Get pick task by ID
      description: Retrieve detailed information about a specific pick task
      tags: [Queries]
      parameters:
        - name: taskId
          in: path
          required: true
          description: Pick task ID
          schema:
            type: string
          example: "PT-a1b2c3d4"
      responses:
        '200':
          description: Pick task details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
        '404':
          description: Task not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tasks/{taskId}/assign:
    post:
      summary: Assign picker to task
      description: |
        Assigns a picker (worker) to a pick task.

        **State Transition:** `pending` → `assigned`

        **Validation:**
        - Task must be in `pending` status
        - Picker must not have too many active tasks
      tags: [Tasks]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
          example: "PT-a1b2c3d4"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignPickerRequest'
            example:
              pickerId: "PICKER-001"
              deviceId: "RF-GUN-042"
      responses:
        '200':
          description: Picker assigned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Task not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tasks/{taskId}/start:
    post:
      summary: Start picking
      description: |
        Marks the task as in progress when the picker begins work.

        **State Transition:** `assigned` → `in_progress`
      tags: [Operations]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tasks/{taskId}/pick:
    post:
      summary: Confirm item picked
      description: |
        Confirms that an item has been picked from the specified location.

        **Behavior:**
        - Updates the picked quantity for the item
        - If all items are picked, auto-completes the task
        - Publishes `ItemPicked` event

        **Validation:**
        - Cannot pick more than required quantity
        - Location must match the item's assigned location
      tags: [Operations]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
          example: "PT-a1b2c3d4"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PickItemRequest'
            examples:
              fullPick:
                summary: Pick full quantity
                value:
                  sku: "WIDGET-001"
                  quantity: 2
                  locationId: "A-1-2-3"
              partialPick:
                summary: Partial pick
                value:
                  sku: "WIDGET-001"
                  quantity: 1
                  locationId: "A-1-2-3"
      responses:
        '200':
          description: Item picked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
        '400':
          description: Invalid pick (wrong quantity, location, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tasks/{taskId}/complete:
    post:
      summary: Complete pick task
      description: |
        Manually completes a pick task.

        **Note:** Tasks auto-complete when all items are picked. This endpoint
        is for manual completion in edge cases.

        **Integration:**
        - Sends signal to WES workflow
        - Publishes `PickTaskCompleted` event
      tags: [Tasks]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                toteId:
                  type: string
                  description: Tote containing picked items
                notes:
                  type: string
            example:
              toteId: "TOTE-001"
      responses:
        '200':
          description: Task completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tasks/{taskId}/exception:
    post:
      summary: Report pick exception
      description: |
        Reports an exception during picking (short pick, damaged item, not found).

        **Exception Types:**
        - `short_pick`: Less inventory than expected
        - `damaged`: Item found but damaged
        - `not_found`: Item not at expected location

        **Handling:**
        - Adjusts expected quantity or marks item as exception
        - May trigger inventory adjustment
        - Publishes `PickException` event
      tags: [Exceptions]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
          example: "PT-a1b2c3d4"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PickExceptionRequest'
            examples:
              shortPick:
                summary: Short pick - less inventory
                value:
                  exceptionType: "short_pick"
                  sku: "WIDGET-001"
                  locationId: "A-1-2-3"
                  expectedQuantity: 5
                  actualQuantity: 3
                  notes: "Only 3 units found at location"
              damaged:
                summary: Damaged item
                value:
                  exceptionType: "damaged"
                  sku: "GADGET-002"
                  locationId: "B-2-3-4"
                  actualQuantity: 1
                  notes: "Packaging torn, item wet"
              notFound:
                summary: Item not found
                value:
                  exceptionType: "not_found"
                  sku: "PART-003"
                  locationId: "C-3-4-5"
                  notes: "Location empty, no product visible"
      responses:
        '200':
          description: Exception reported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
        '400':
          description: Invalid exception data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tasks/{taskId}/cancel:
    post:
      summary: Cancel pick task
      description: |
        Cancels a pick task. Only allowed for tasks not yet completed.

        **Integration:**
        - Notifies WES workflow of cancellation
        - Publishes `PickTaskCancelled` event
      tags: [Tasks]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
            example:
              reason: "Order cancelled by customer"
      responses:
        '200':
          description: Task cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
        '400':
          description: Cannot cancel task in current state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tasks/picker/{pickerId}/active:
    get:
      summary: Get active tasks for picker
      description: Retrieve all active (non-completed) tasks assigned to a picker
      tags: [Queries]
      parameters:
        - name: pickerId
          in: path
          required: true
          description: Picker (worker) ID
          schema:
            type: string
          example: "PICKER-001"
      responses:
        '200':
          description: Active tasks for picker
          content:
            application/json:
              schema:
                type: object
                properties:
                  pickerId:
                    type: string
                  activeTasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/PickTaskResponse'
                  totalActive:
                    type: integer
              example:
                pickerId: "PICKER-001"
                activeTasks:
                  - taskId: "PT-a1b2c3d4"
                    orderId: "ORD-12345"
                    status: "in_progress"
                    items:
                      - sku: "WIDGET-001"
                        quantity: 2
                        locationId: "A-1-2-3"
                        picked: true
                        pickedQty: 2
                    totalItems: 1
                    totalQuantity: 2
                totalActive: 1

  /tasks/order/{orderId}:
    get:
      summary: Get pick task by order ID
      description: Retrieve the pick task associated with an order
      tags: [Queries]
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
          example: "ORD-A1B2C3D4"
      responses:
        '200':
          description: Pick task for order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PickTaskResponse'
        '404':
          description: No pick task found for order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tasks/pending:
    get:
      summary: Get pending tasks
      description: Retrieve all tasks waiting to be assigned
      tags: [Queries]
      parameters:
        - name: zone
          in: query
          description: Filter by warehouse zone
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Pending tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PickTaskResponse'

  /health:
    get:
      summary: Health check
      description: Returns the health status of the service
      tags: [Health]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"

  /ready:
    get:
      summary: Readiness check
      description: Returns the readiness status of the service
      tags: [Health]
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "ready"

components:
  schemas:
    CreatePickTaskRequest:
      type: object
      required:
        - orderId
        - items
      properties:
        orderId:
          type: string
          description: Order ID this task is for
          example: "ORD-A1B2C3D4"
        routeId:
          type: string
          description: WES route ID for tracking
          example: "RT-xyz123"
        waveId:
          type: string
          description: Wave ID if wave-based picking
          example: "WV-DIG-20241224-001"
        toteId:
          type: string
          description: Tote to place picked items
          example: "TOTE-001"
        items:
          type: array
          description: Items to pick
          items:
            $ref: '#/components/schemas/PickItem'

    PickItem:
      type: object
      required:
        - sku
        - quantity
        - locationId
      properties:
        sku:
          type: string
          description: Product SKU
          example: "WIDGET-001"
        quantity:
          type: integer
          minimum: 1
          description: Quantity to pick
          example: 2
        locationId:
          type: string
          description: Warehouse location (Zone-Aisle-Bay-Level)
          example: "A-1-2-3"
        productName:
          type: string
          description: Product name for picker display
          example: "Premium Widget"

    PickTaskResponse:
      type: object
      properties:
        taskId:
          type: string
          description: Unique task identifier
          example: "PT-a1b2c3d4"
        orderId:
          type: string
          description: Associated order ID
          example: "ORD-A1B2C3D4"
        routeId:
          type: string
          description: WES route ID
          example: "RT-xyz123"
        waveId:
          type: string
          description: Wave ID if applicable
        pickerId:
          type: string
          description: Assigned picker ID
          example: "PICKER-001"
        toteId:
          type: string
          description: Tote for picked items
          example: "TOTE-001"
        status:
          $ref: '#/components/schemas/PickTaskStatus'
        items:
          type: array
          items:
            $ref: '#/components/schemas/PickItemStatus'
        exceptions:
          type: array
          items:
            $ref: '#/components/schemas/PickException'
        totalItems:
          type: integer
          description: Total number of distinct items
        totalQuantity:
          type: integer
          description: Total quantity to pick
        pickedQuantity:
          type: integer
          description: Total quantity picked so far
        duration:
          type: string
          description: ISO 8601 duration if completed
          example: "PT12M30S"
        createdAt:
          type: string
          format: date-time
        assignedAt:
          type: string
          format: date-time
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time

    PickTaskStatus:
      type: string
      enum:
        - pending
        - assigned
        - in_progress
        - completed
        - cancelled
      description: |
        Task status:
        - `pending`: Created, waiting for picker assignment
        - `assigned`: Picker assigned, ready to start
        - `in_progress`: Picker actively picking items
        - `completed`: All items picked
        - `cancelled`: Task cancelled

    PickItemStatus:
      type: object
      properties:
        sku:
          type: string
          example: "WIDGET-001"
        quantity:
          type: integer
          description: Quantity to pick
          example: 2
        locationId:
          type: string
          example: "A-1-2-3"
        productName:
          type: string
        picked:
          type: boolean
          description: Whether all quantity has been picked
          example: true
        pickedQty:
          type: integer
          description: Quantity picked so far
          example: 2
        hasException:
          type: boolean
          description: Whether this item has an exception

    PickException:
      type: object
      properties:
        sku:
          type: string
        locationId:
          type: string
        exceptionType:
          type: string
          enum: [short_pick, damaged, not_found]
        expectedQuantity:
          type: integer
        actualQuantity:
          type: integer
        notes:
          type: string
        reportedAt:
          type: string
          format: date-time

    AssignPickerRequest:
      type: object
      required:
        - pickerId
      properties:
        pickerId:
          type: string
          description: Picker (worker) ID to assign
          example: "PICKER-001"
        deviceId:
          type: string
          description: RF gun or device ID
          example: "RF-GUN-042"

    PickItemRequest:
      type: object
      required:
        - sku
        - quantity
        - locationId
      properties:
        sku:
          type: string
          description: Product SKU being picked
          example: "WIDGET-001"
        quantity:
          type: integer
          minimum: 1
          description: Quantity picked
          example: 2
        locationId:
          type: string
          description: Location picked from
          example: "A-1-2-3"

    PickExceptionRequest:
      type: object
      required:
        - exceptionType
        - sku
      properties:
        exceptionType:
          type: string
          enum: [short_pick, damaged, not_found]
          description: Type of picking exception
        sku:
          type: string
          description: Product SKU with exception
          example: "WIDGET-001"
        locationId:
          type: string
          description: Location where exception occurred
          example: "A-1-2-3"
        expectedQuantity:
          type: integer
          description: Expected quantity (for short_pick)
        actualQuantity:
          type: integer
          description: Actual quantity found
        notes:
          type: string
          description: Additional notes from picker

    Pagination:
      type: object
      properties:
        page:
          type: integer
        pageSize:
          type: integer
        total:
          type: integer
        hasMore:
          type: boolean

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "healthy"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: "task not found"
        code:
          type: string
          description: Error code
          example: "NOT_FOUND"
        details:
          type: object
          description: Additional error details

  parameters:
    # WMS Tenant Context Headers (Multi-Tenancy - REQUIRED)
    TenantIdHeader:
      name: X-WMS-Tenant-ID
      in: header
      required: true
      description: |
        Tenant identifier for multi-tenant isolation.
        Required for all API operations to ensure proper data segregation.
      schema:
        type: string
      example: "tenant-001"

    FacilityIdHeader:
      name: X-WMS-Facility-ID
      in: header
      required: true
      description: |
        Facility/distribution center identifier.
        Required for all API operations to route requests to the correct facility.
      schema:
        type: string
      example: "facility-east"

    WarehouseIdHeader:
      name: X-WMS-Warehouse-ID
      in: header
      required: true
      description: |
        Warehouse identifier within the facility.
        Required for all API operations for warehouse-specific processing.
      schema:
        type: string
      example: "warehouse-a"

    SellerIdHeader:
      name: X-WMS-Seller-ID
      in: header
      required: false
      description: |
        Seller identifier for marketplace operations.
        Optional - used for multi-seller scenarios.
      schema:
        type: string
      example: "seller-123"

    ChannelIdHeader:
      name: X-WMS-Channel-ID
      in: header
      required: false
      description: |
        Sales channel identifier (e.g., web, mobile, marketplace).
        Optional - used for channel-specific processing.
      schema:
        type: string
      example: "web"

    # CloudEvents Extensions Headers
    WMSCorrelationID:
      name: X-WMS-Correlation-ID
      in: header
      description: CloudEvents extension for distributed tracing and correlation across WMS services
      required: false
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

    WMSWaveNumber:
      name: X-WMS-Wave-Number
      in: header
      description: CloudEvents extension for wave-based processing correlation
      required: false
      schema:
        type: string
      example: "WAVE-2024-00123"

    WMSWorkflowID:
      name: X-WMS-Workflow-ID
      in: header
      description: CloudEvents extension for Temporal workflow correlation
      required: false
      schema:
        type: string
      example: "order-fulfillment-ORD-12345"
