asyncapi: 3.0.0
info:
  title: WMS Picking Service Events
  version: 1.0.0
  description: |
    AsyncAPI specification for Picking Service domain events.

    The Picking service publishes events to track pick task execution progress.
    Events follow the CloudEvents 1.0 specification.

    **Event Flow:**
    1. PickTaskCreated - When a new pick task is created
    2. PickTaskAssigned - When a picker is assigned to a task
    3. PickTaskStarted - When picker begins work
    4. ItemPicked - When each item is picked
    5. PickException - When a picking exception occurs
    6. PickTaskCompleted - When all items are picked
    7. PickTaskCancelled - When a task is cancelled

    **Integration:**
    - WES listens for PickTaskCompleted to advance route stages
    - Inventory service listens for picking events to track stock
  contact:
    name: WMS Platform Team
    email: wms@example.com

servers:
  kafka:
    host: localhost:9092
    protocol: kafka
    description: Local Kafka broker

defaultContentType: application/json

channels:
  wms.picking.events:
    address: wms.picking.events
    description: Picking task events topic (6 partitions, keyed by orderId)
    messages:
      pickTaskCreated:
        $ref: '#/components/messages/PickTaskCreatedEvent'
      pickTaskAssigned:
        $ref: '#/components/messages/PickTaskAssignedEvent'
      pickTaskStarted:
        $ref: '#/components/messages/PickTaskStartedEvent'
      itemPicked:
        $ref: '#/components/messages/ItemPickedEvent'
      pickException:
        $ref: '#/components/messages/PickExceptionEvent'
      pickTaskCompleted:
        $ref: '#/components/messages/PickTaskCompletedEvent'
      pickTaskCancelled:
        $ref: '#/components/messages/PickTaskCancelledEvent'

operations:
  publishPickTaskCreated:
    action: send
    channel:
      $ref: '#/channels/wms.picking.events'
    summary: Publish pick task created event
    description: Published when a new pick task is created for an order
    messages:
      - $ref: '#/channels/wms.picking.events/messages/pickTaskCreated'

  publishPickTaskAssigned:
    action: send
    channel:
      $ref: '#/channels/wms.picking.events'
    summary: Publish pick task assigned event
    description: Published when a picker is assigned to a task
    messages:
      - $ref: '#/channels/wms.picking.events/messages/pickTaskAssigned'

  publishPickTaskStarted:
    action: send
    channel:
      $ref: '#/channels/wms.picking.events'
    summary: Publish pick task started event
    description: Published when a picker begins work on a task
    messages:
      - $ref: '#/channels/wms.picking.events/messages/pickTaskStarted'

  publishItemPicked:
    action: send
    channel:
      $ref: '#/channels/wms.picking.events'
    summary: Publish item picked event
    description: Published when an item is picked from a location
    messages:
      - $ref: '#/channels/wms.picking.events/messages/itemPicked'

  publishPickException:
    action: send
    channel:
      $ref: '#/channels/wms.picking.events'
    summary: Publish pick exception event
    description: Published when a picking exception occurs (short pick, damaged, not found)
    messages:
      - $ref: '#/channels/wms.picking.events/messages/pickException'

  publishPickTaskCompleted:
    action: send
    channel:
      $ref: '#/channels/wms.picking.events'
    summary: Publish pick task completed event
    description: Published when all items in a pick task are picked
    messages:
      - $ref: '#/channels/wms.picking.events/messages/pickTaskCompleted'

  publishPickTaskCancelled:
    action: send
    channel:
      $ref: '#/channels/wms.picking.events'
    summary: Publish pick task cancelled event
    description: Published when a pick task is cancelled
    messages:
      - $ref: '#/channels/wms.picking.events/messages/pickTaskCancelled'

components:
  messages:
    PickTaskCreatedEvent:
      name: PickTaskCreatedEvent
      title: Pick Task Created
      summary: Published when a new pick task is created
      description: |
        Triggered when WES creates a pick task during route execution.
        Contains the list of items to be picked and their locations.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/PickTaskCreatedPayload'
      examples:
        - name: singleItemTask
          summary: Single item pick task
          payload:
            taskId: "PT-a1b2c3d4"
            orderId: "ORD-12345678"
            waveId: "WV-DIG-20241224-001"
            routeId: "RT-xyz123"
            items:
              - sku: "WIDGET-001"
                quantity: 2
                locationId: "A-1-2-3"
            totalItems: 1
            totalQuantity: 2
            createdAt: "2024-12-24T10:00:00Z"

    PickTaskAssignedEvent:
      name: PickTaskAssignedEvent
      title: Pick Task Assigned
      summary: Published when a picker is assigned to a task
      description: |
        Triggered when a picker (worker) is assigned to a pick task.
        The task is now ready to be started.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/PickTaskAssignedPayload'
      examples:
        - name: assigned
          summary: Picker assigned to task
          payload:
            taskId: "PT-a1b2c3d4"
            orderId: "ORD-12345678"
            pickerId: "PICKER-001"
            deviceId: "RF-GUN-042"
            assignedAt: "2024-12-24T10:05:00Z"

    PickTaskStartedEvent:
      name: PickTaskStartedEvent
      title: Pick Task Started
      summary: Published when a picker begins work on a task
      description: |
        Triggered when the picker starts the picking process.
        Marks the beginning of actual work on the task.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/PickTaskStartedPayload'
      examples:
        - name: started
          summary: Pick task started
          payload:
            taskId: "PT-a1b2c3d4"
            orderId: "ORD-12345678"
            pickerId: "PICKER-001"
            startedAt: "2024-12-24T10:06:00Z"

    ItemPickedEvent:
      name: ItemPickedEvent
      title: Item Picked
      summary: Published when an item is picked from a location
      description: |
        Triggered each time a picker confirms an item pick.
        Used for real-time tracking and inventory updates.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/ItemPickedPayload'
      examples:
        - name: itemPicked
          summary: Item picked from location
          payload:
            taskId: "PT-a1b2c3d4"
            orderId: "ORD-12345678"
            sku: "WIDGET-001"
            quantity: 2
            locationId: "A-1-2-3"
            toteId: "TOTE-001"
            pickedAt: "2024-12-24T10:10:00Z"

    PickExceptionEvent:
      name: PickExceptionEvent
      title: Pick Exception
      summary: Published when a picking exception occurs
      description: |
        Triggered when the picker reports a problem:
        - short_pick: Less inventory than expected
        - damaged: Item found but damaged
        - not_found: Item not at expected location

        May trigger inventory adjustments and order fulfillment delays.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/PickExceptionPayload'
      examples:
        - name: shortPick
          summary: Short pick exception
          payload:
            taskId: "PT-a1b2c3d4"
            orderId: "ORD-12345678"
            sku: "WIDGET-001"
            locationId: "A-1-2-3"
            exceptionType: "short_pick"
            expectedQuantity: 5
            actualQuantity: 3
            notes: "Only 3 units found at location"
            reportedAt: "2024-12-24T10:12:00Z"

    PickTaskCompletedEvent:
      name: PickTaskCompletedEvent
      title: Pick Task Completed
      summary: Published when all items are picked
      description: |
        Triggered when all items in a pick task are successfully picked.
        WES listens for this event to advance to the next stage.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/PickTaskCompletedPayload'
      examples:
        - name: completed
          summary: Pick task completed
          payload:
            taskId: "PT-a1b2c3d4"
            orderId: "ORD-12345678"
            routeId: "RT-xyz123"
            pickerId: "PICKER-001"
            toteId: "TOTE-001"
            pickedItems:
              - sku: "WIDGET-001"
                quantity: 2
                locationId: "A-1-2-3"
            totalItems: 1
            totalQuantity: 2
            duration: "PT12M30S"
            completedAt: "2024-12-24T10:18:30Z"

    PickTaskCancelledEvent:
      name: PickTaskCancelledEvent
      title: Pick Task Cancelled
      summary: Published when a pick task is cancelled
      description: |
        Triggered when a pick task is cancelled (e.g., order cancelled).
        WES will handle the route accordingly.
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/PickTaskCancelledPayload'
      examples:
        - name: cancelled
          summary: Pick task cancelled
          payload:
            taskId: "PT-a1b2c3d4"
            orderId: "ORD-12345678"
            reason: "Order cancelled by customer"
            cancelledAt: "2024-12-24T10:15:00Z"

  schemas:
    CloudEventHeaders:
      $ref: '../../../shared/docs/asyncapi-cloudevents-schema.yaml#/CloudEventHeaders'
    PickTaskCreatedPayload:
      type: object
      properties:
        taskId:
          type: string
          description: Unique pick task identifier
          example: "PT-a1b2c3d4"
        orderId:
          type: string
          description: Associated order ID
          example: "ORD-12345678"
        waveId:
          type: string
          description: Wave ID if wave-based picking
          example: "WV-DIG-20241224-001"
        routeId:
          type: string
          description: WES route ID
          example: "RT-xyz123"
        items:
          type: array
          description: Items to pick
          items:
            type: object
            properties:
              sku:
                type: string
              quantity:
                type: integer
              locationId:
                type: string
        totalItems:
          type: integer
          description: Number of distinct items
        totalQuantity:
          type: integer
          description: Total quantity to pick
        createdAt:
          type: string
          format: date-time

    PickTaskAssignedPayload:
      type: object
      properties:
        taskId:
          type: string
          example: "PT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        pickerId:
          type: string
          description: Assigned picker ID
          example: "PICKER-001"
        deviceId:
          type: string
          description: RF gun or device ID
          example: "RF-GUN-042"
        assignedAt:
          type: string
          format: date-time

    PickTaskStartedPayload:
      type: object
      properties:
        taskId:
          type: string
          example: "PT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        pickerId:
          type: string
          example: "PICKER-001"
        startedAt:
          type: string
          format: date-time

    ItemPickedPayload:
      type: object
      properties:
        taskId:
          type: string
          example: "PT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        sku:
          type: string
          description: Product SKU picked
          example: "WIDGET-001"
        quantity:
          type: integer
          description: Quantity picked
          example: 2
        locationId:
          type: string
          description: Location picked from
          example: "A-1-2-3"
        toteId:
          type: string
          description: Tote placed into
          example: "TOTE-001"
        pickedAt:
          type: string
          format: date-time

    PickExceptionPayload:
      type: object
      properties:
        taskId:
          type: string
          example: "PT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        sku:
          type: string
          example: "WIDGET-001"
        locationId:
          type: string
          example: "A-1-2-3"
        exceptionType:
          type: string
          enum: [short_pick, damaged, not_found]
          description: Type of exception
        expectedQuantity:
          type: integer
          description: Expected quantity at location
        actualQuantity:
          type: integer
          description: Actual quantity found
        notes:
          type: string
          description: Picker notes
        reportedAt:
          type: string
          format: date-time

    PickTaskCompletedPayload:
      type: object
      properties:
        taskId:
          type: string
          example: "PT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        routeId:
          type: string
          example: "RT-xyz123"
        pickerId:
          type: string
          example: "PICKER-001"
        toteId:
          type: string
          description: Tote containing picked items
          example: "TOTE-001"
        pickedItems:
          type: array
          items:
            type: object
            properties:
              sku:
                type: string
              quantity:
                type: integer
              locationId:
                type: string
        totalItems:
          type: integer
        totalQuantity:
          type: integer
        duration:
          type: string
          description: ISO 8601 duration
          example: "PT12M30S"
        completedAt:
          type: string
          format: date-time

    PickTaskCancelledPayload:
      type: object
      properties:
        taskId:
          type: string
          example: "PT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        reason:
          type: string
          description: Cancellation reason
          example: "Order cancelled by customer"
        cancelledAt:
          type: string
          format: date-time
