asyncapi: 3.0.0
info:
  title: WMS WES Service Events
  version: 1.0.0
  description: |
    AsyncAPI specification for WES (Warehouse Execution System) domain events.

    The WES service publishes events to track route and stage execution progress.
    Events follow the CloudEvents 1.0 specification.

    **Event Flow:**
    1. RouteCreated - When a new task route is created
    2. StageAssigned - When a worker is assigned to a stage
    3. StageStarted - When stage execution begins
    4. StageCompleted - When a stage completes successfully
    5. StageFailed - When a stage fails
    6. RouteCompleted - When all stages are complete
    7. RouteFailed - When the route fails
  contact:
    name: WMS Platform Team
    email: wms@example.com

servers:
  kafka:
    host: localhost:9092
    protocol: kafka
    description: Local Kafka broker

defaultContentType: application/json

channels:
  wms.wes.events:
    address: wms.wes.events
    description: WES execution events topic
    messages:
      routeCreated:
        $ref: '#/components/messages/RouteCreatedEvent'
      stageAssigned:
        $ref: '#/components/messages/StageAssignedEvent'
      stageStarted:
        $ref: '#/components/messages/StageStartedEvent'
      stageCompleted:
        $ref: '#/components/messages/StageCompletedEvent'
      stageFailed:
        $ref: '#/components/messages/StageFailedEvent'
      routeCompleted:
        $ref: '#/components/messages/RouteCompletedEvent'
      routeFailed:
        $ref: '#/components/messages/RouteFailedEvent'

operations:
  publishRouteCreated:
    action: send
    channel:
      $ref: '#/channels/wms.wes.events'
    summary: Publish route created event
    messages:
      - $ref: '#/channels/wms.wes.events/messages/routeCreated'

  publishStageAssigned:
    action: send
    channel:
      $ref: '#/channels/wms.wes.events'
    summary: Publish stage assigned event
    messages:
      - $ref: '#/channels/wms.wes.events/messages/stageAssigned'

  publishStageStarted:
    action: send
    channel:
      $ref: '#/channels/wms.wes.events'
    summary: Publish stage started event
    messages:
      - $ref: '#/channels/wms.wes.events/messages/stageStarted'

  publishStageCompleted:
    action: send
    channel:
      $ref: '#/channels/wms.wes.events'
    summary: Publish stage completed event
    messages:
      - $ref: '#/channels/wms.wes.events/messages/stageCompleted'

  publishStageFailed:
    action: send
    channel:
      $ref: '#/channels/wms.wes.events'
    summary: Publish stage failed event
    messages:
      - $ref: '#/channels/wms.wes.events/messages/stageFailed'

  publishRouteCompleted:
    action: send
    channel:
      $ref: '#/channels/wms.wes.events'
    summary: Publish route completed event
    messages:
      - $ref: '#/channels/wms.wes.events/messages/routeCompleted'

  publishRouteFailed:
    action: send
    channel:
      $ref: '#/channels/wms.wes.events'
    summary: Publish route failed event
    messages:
      - $ref: '#/channels/wms.wes.events/messages/routeFailed'

components:
  messages:
    RouteCreatedEvent:
      name: RouteCreatedEvent
      title: Route Created
      summary: Published when a new task route is created
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RouteCreatedPayload'

    StageAssignedEvent:
      name: StageAssignedEvent
      title: Stage Assigned
      summary: Published when a worker is assigned to a stage
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/StageAssignedPayload'

    StageStartedEvent:
      name: StageStartedEvent
      title: Stage Started
      summary: Published when stage execution begins
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/StageStartedPayload'

    StageCompletedEvent:
      name: StageCompletedEvent
      title: Stage Completed
      summary: Published when a stage completes successfully
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/StageCompletedPayload'

    StageFailedEvent:
      name: StageFailedEvent
      title: Stage Failed
      summary: Published when a stage fails
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/StageFailedPayload'

    RouteCompletedEvent:
      name: RouteCompletedEvent
      title: Route Completed
      summary: Published when all stages are complete
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RouteCompletedPayload'

    RouteFailedEvent:
      name: RouteFailedEvent
      title: Route Failed
      summary: Published when the route fails
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CloudEventHeaders'
      payload:
        $ref: '#/components/schemas/RouteFailedPayload'

  schemas:
    CloudEventHeaders:
      type: object
      properties:
        ce_specversion:
          type: string
          const: '1.0'
        ce_type:
          type: string
          description: Event type
        ce_source:
          type: string
          const: '/wms/wes-service'
        ce_subject:
          type: string
          description: Route ID
        ce_id:
          type: string
          format: uuid
        ce_time:
          type: string
          format: date-time
        ce_datacontenttype:
          type: string
          const: 'application/json'

    RouteCreatedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        waveId:
          type: string
          example: "WV-DIG-20241230-001"
        pathType:
          type: string
          enum: [pick_pack, pick_wall_pack, pick_consolidate_pack]
          example: "pick_wall_pack"
        stages:
          type: array
          items:
            type: string
          example: ["picking", "walling", "packing"]
        createdAt:
          type: string
          format: date-time

    StageAssignedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        stageType:
          type: string
          enum: [picking, walling, consolidation, packing]
          example: "picking"
        stageIndex:
          type: integer
          example: 0
        workerId:
          type: string
          example: "PICKER-001"
        taskId:
          type: string
          example: "PT-12345"
        assignedAt:
          type: string
          format: date-time

    StageStartedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        stageType:
          type: string
          enum: [picking, walling, consolidation, packing]
          example: "picking"
        stageIndex:
          type: integer
          example: 0
        workerId:
          type: string
          example: "PICKER-001"
        startedAt:
          type: string
          format: date-time

    StageCompletedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        stageType:
          type: string
          enum: [picking, walling, consolidation, packing]
          example: "picking"
        stageIndex:
          type: integer
          example: 0
        taskId:
          type: string
          example: "PT-12345"
        workerId:
          type: string
          example: "PICKER-001"
        duration:
          type: string
          description: ISO 8601 duration
          example: "PT12M30S"
        completedAt:
          type: string
          format: date-time

    StageFailedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        stageType:
          type: string
          enum: [picking, walling, consolidation, packing]
          example: "picking"
        stageIndex:
          type: integer
          example: 0
        error:
          type: string
          example: "Picker reported item shortage"
        failedAt:
          type: string
          format: date-time

    RouteCompletedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        pathType:
          type: string
          enum: [pick_pack, pick_wall_pack, pick_consolidate_pack]
          example: "pick_wall_pack"
        stagesCompleted:
          type: integer
          example: 3
        totalDuration:
          type: string
          description: ISO 8601 duration
          example: "PT45M"
        completedAt:
          type: string
          format: date-time

    RouteFailedPayload:
      type: object
      properties:
        routeId:
          type: string
          example: "RT-a1b2c3d4"
        orderId:
          type: string
          example: "ORD-12345678"
        failedStage:
          type: string
          enum: [picking, walling, consolidation, packing]
          example: "picking"
        error:
          type: string
          example: "Picker reported item shortage"
        failedAt:
          type: string
          format: date-time
