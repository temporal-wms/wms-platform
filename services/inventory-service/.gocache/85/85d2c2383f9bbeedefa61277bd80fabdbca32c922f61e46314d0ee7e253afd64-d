//line /Users/claudioed/development/github/temporal-war/wms-platform/services/inventory-service/internal/domain/inventory_reservation.go:1:1
package domain

import (
	"errors"
	"time"

	"go.mongodb.org/mongo-driver/bson/primitive"
)

var (
	ErrReservationExpired     = errors.New("reservation has expired")
	ErrReservationNotActive   = errors.New("reservation is not active")
	ErrReservationAlreadyUsed = errors.New("reservation has already been used")
)

// ReservationStatus represents the status of a reservation
type ReservationStatus string

const (
	ReservationStatusActive    ReservationStatus = "active"
	ReservationStatusStaged    ReservationStatus = "staged"
	ReservationStatusFulfilled ReservationStatus = "fulfilled"
	ReservationStatusCancelled ReservationStatus = "cancelled"
	ReservationStatusExpired   ReservationStatus = "expired"
)

// InventoryReservationAggregate represents a stock reservation as a separate aggregate
// This prevents unbounded growth of reservations array in InventoryItem
type InventoryReservationAggregate struct {
	ID            primitive.ObjectID `bson:"_id,omitempty"`
	ReservationID string             `bson:"reservationId"`
	SKU           string             `bson:"sku"` // Reference to inventory item

	// Multi-tenant fields
	TenantID    string `bson:"tenantId"`
	FacilityID  string `bson:"facilityId"`
	WarehouseID string `bson:"warehouseId"`
	SellerID    string `bson:"sellerId,omitempty"`

	OrderID    string            `bson:"orderId"`
	Quantity   int               `bson:"quantity"`
	LocationID string            `bson:"locationId"`
	Status     ReservationStatus `bson:"status"`
	UnitIDs    []string          `bson:"unitIds,omitempty"` // Specific units reserved for unit-level tracking

	CreatedAt time.Time `bson:"createdAt"`
	ExpiresAt time.Time `bson:"expiresAt"`
	UpdatedAt time.Time `bson:"updatedAt"`

	// Optional: Track who/what created/updated the reservation
	CreatedBy string `bson:"createdBy,omitempty"`
	UpdatedBy string `bson:"updatedBy,omitempty"`

	DomainEvents []DomainEvent `bson:"-"`
}

// ReservationTenantInfo holds multi-tenant identification for reservations
type ReservationTenantInfo struct {
	TenantID    string
	FacilityID  string
	WarehouseID string
	SellerID    string
}

// NewInventoryReservation creates a new inventory reservation aggregate
func NewInventoryReservation(
	reservationID string,
	sku string,
	orderID string,
	locationID string,
	quantity int,
	unitIDs []string,
	createdBy string,
	tenant *ReservationTenantInfo,
) *InventoryReservationAggregate {goCover_4dfb824e56d3__91[0] = 3 ; goCover_4dfb824e56d3__91[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__91[2] = 91 ; goCover_4dfb824e56d3__91[3] = 1;
	now := time.Now()
	reservation := &InventoryReservationAggregate{
		ReservationID: reservationID,
		SKU:           sku,
		OrderID:       orderID,
		Quantity:      quantity,
		LocationID:    locationID,
		Status:        ReservationStatusActive,
		UnitIDs:       unitIDs,
		CreatedAt:     now,
		ExpiresAt:     now.Add(24 * time.Hour), // Default 24hr expiration
		UpdatedAt:     now,
		CreatedBy:     createdBy,
		DomainEvents:  make([]DomainEvent, 0),
	}

	if tenant != nil {goCover_4dfb824e56d3__91[5] = 1;
		reservation.TenantID = tenant.TenantID
		reservation.FacilityID = tenant.FacilityID
		reservation.WarehouseID = tenant.WarehouseID
		reservation.SellerID = tenant.SellerID
	}

	goCover_4dfb824e56d3__91[4] = 1;return reservation
}

// MarkStaged marks the reservation as staged (hard allocated)
func (r *InventoryReservationAggregate) MarkStaged(updatedBy string) error {goCover_4dfb824e56d3__92[0] = 5 ; goCover_4dfb824e56d3__92[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__92[2] = 92 ; goCover_4dfb824e56d3__92[3] = 1;
	if r.Status != ReservationStatusActive {goCover_4dfb824e56d3__92[6] = 1;
		return ErrReservationNotActive
	}

	goCover_4dfb824e56d3__92[4] = 1;if time.Now().After(r.ExpiresAt) {goCover_4dfb824e56d3__92[7] = 1;
		return ErrReservationExpired
	}

	goCover_4dfb824e56d3__92[5] = 1;r.Status = ReservationStatusStaged
	r.UpdatedAt = time.Now()
	r.UpdatedBy = updatedBy

	return nil
}

// MarkFulfilled marks the reservation as fulfilled (shipped)
func (r *InventoryReservationAggregate) MarkFulfilled(updatedBy string) error {goCover_4dfb824e56d3__93[0] = 3 ; goCover_4dfb824e56d3__93[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__93[2] = 93 ; goCover_4dfb824e56d3__93[3] = 1;
	if r.Status != ReservationStatusStaged && r.Status != ReservationStatusActive {goCover_4dfb824e56d3__93[5] = 1;
		return ErrReservationAlreadyUsed
	}

	goCover_4dfb824e56d3__93[4] = 1;r.Status = ReservationStatusFulfilled
	r.UpdatedAt = time.Now()
	r.UpdatedBy = updatedBy

	return nil
}

// Cancel cancels the reservation
func (r *InventoryReservationAggregate) Cancel(updatedBy string, reason string) error {goCover_4dfb824e56d3__94[0] = 3 ; goCover_4dfb824e56d3__94[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__94[2] = 94 ; goCover_4dfb824e56d3__94[3] = 1;
	if r.Status == ReservationStatusFulfilled {goCover_4dfb824e56d3__94[5] = 1;
		return errors.New("cannot cancel fulfilled reservation")
	}

	goCover_4dfb824e56d3__94[4] = 1;r.Status = ReservationStatusCancelled
	r.UpdatedAt = time.Now()
	r.UpdatedBy = updatedBy

	return nil
}

// MarkExpired marks the reservation as expired
func (r *InventoryReservationAggregate) MarkExpired() {goCover_4dfb824e56d3__95[0] = 2 ; goCover_4dfb824e56d3__95[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__95[2] = 95 ; goCover_4dfb824e56d3__95[3] = 1;
	if r.Status == ReservationStatusActive && time.Now().After(r.ExpiresAt) {goCover_4dfb824e56d3__95[4] = 1;
		r.Status = ReservationStatusExpired
		r.UpdatedAt = time.Now()
	}
}

// IsActive returns true if the reservation is active and not expired
func (r *InventoryReservationAggregate) IsActive() bool {goCover_4dfb824e56d3__96[0] = 1 ; goCover_4dfb824e56d3__96[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__96[2] = 96 ; goCover_4dfb824e56d3__96[3] = 1;
	return r.Status == ReservationStatusActive && time.Now().Before(r.ExpiresAt)
}

// IsExpired returns true if the reservation has expired
func (r *InventoryReservationAggregate) IsExpired() bool {goCover_4dfb824e56d3__97[0] = 1 ; goCover_4dfb824e56d3__97[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__97[2] = 97 ; goCover_4dfb824e56d3__97[3] = 1;
	return time.Now().After(r.ExpiresAt)
}

// ExtendExpiration extends the reservation expiration time
func (r *InventoryReservationAggregate) ExtendExpiration(duration time.Duration) error {goCover_4dfb824e56d3__98[0] = 3 ; goCover_4dfb824e56d3__98[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__98[2] = 98 ; goCover_4dfb824e56d3__98[3] = 1;
	if r.Status != ReservationStatusActive {goCover_4dfb824e56d3__98[5] = 1;
		return ErrReservationNotActive
	}

	goCover_4dfb824e56d3__98[4] = 1;r.ExpiresAt = r.ExpiresAt.Add(duration)
	r.UpdatedAt = time.Now()

	return nil
}

// AddDomainEvent adds a domain event
func (r *InventoryReservationAggregate) AddDomainEvent(event DomainEvent) {goCover_4dfb824e56d3__99[0] = 1 ; goCover_4dfb824e56d3__99[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__99[2] = 99 ; goCover_4dfb824e56d3__99[3] = 1;
	r.DomainEvents = append(r.DomainEvents, event)
}

// ClearDomainEvents clears all domain events
func (r *InventoryReservationAggregate) ClearDomainEvents() {goCover_4dfb824e56d3__100[0] = 1 ; goCover_4dfb824e56d3__100[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__100[2] = 100 ; goCover_4dfb824e56d3__100[3] = 1;
	r.DomainEvents = make([]DomainEvent, 0)
}

// GetDomainEvents returns all domain events
func (r *InventoryReservationAggregate) GetDomainEvents() []DomainEvent {goCover_4dfb824e56d3__101[0] = 1 ; goCover_4dfb824e56d3__101[1] = goCover_4dfb824e56d3_P ; goCover_4dfb824e56d3__101[2] = 101 ; goCover_4dfb824e56d3__101[3] = 1;
	return r.DomainEvents
}
